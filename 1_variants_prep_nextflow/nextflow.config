manifest {
    name        = 'variants-prep-nextflow'
    author      = 'gene_exp'
    description = 'TSSÂ±pad BED + Hail gnomAD v4.1 export pipeline'
    mainScript  = 'main.nf'
}

params {
    pad_tss         = 10_000
    gnomad_ht       = 'gs://gcp-public-data--gnomad/release/4.1/ht/genomes/gnomad.genomes.v4.1.sites.ht/'
    tmp_dir         = './tmp'
    spark_conf      = null
    runtime_conf    = null
    gcs_connector_jar = null
    hail_home       = null
    conda_env       = null
}

process {
    errorStrategy = 'terminate'
    shell         = ['/bin/bash', '-euo', 'pipefail', '-c']

    withName: EXTRACT_ENSG {
        cpus   = { params.cpus ?: 1 }
        memory = { params.memory ?: '2 GB' }
    }

    withName: BUILD_TSS_BED {
        cpus   = { params.cpus ?: 2 }
        memory = { params.memory ?: '4 GB' }
    }

    withName: HAIL_EXPORT_PER_GENE {
        cpus   = { params.cpus ?: 4 }
        memory = { params.memory ?: '16 GB' }
    }

    withName: MERGE_VARIANTS {
        cpus   = { params.cpus ?: 2 }
        memory = { params.memory ?: '4 GB' }
    }
}

timeline {
    enabled = true
    file    = "${projectDir}/reports/timeline.html"
}

report {
    enabled = true
    file    = "${projectDir}/reports/report.html"
}

trace {
    enabled = true
    file    = "${projectDir}/reports/trace.txt"
}

env {
    GCS_CONNECTOR_JAR = params.gcs_connector_jar
    HAIL_HOME         = params.hail_home
}

profiles {
    local {
        process.executor = 'local'
    }

    hpc {
        process.executor = 'local'
    }

    gcp {
        process.executor = 'local'
    }

    docker {
        docker.enabled     = true
        docker.runOptions  = '-u \$(id -u):\$(id -g)'
        process.container  = 'hailgenetics/hail:0.2.133'
    }

    singularity {
        singularity.enabled    = true
        process.container      = 'hailgenetics/hail:0.2.133'
        singularity.autoMounts = true
    }

    conda {
        conda.enabled = true
        process.conda = { params.conda_env ?: "${projectDir}/conf/conda/hail.yml" }
    }
}


